{% extends "base.html" %}

{% block content %}
<style>
.outcomes-container {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 2rem;
    align-items: start;
}

.main-content {
    min-width: 0;
}

.chart-sidebar {
    position: sticky;
    top: 1rem;
}

.chart-sidebar canvas {
    max-width: 100%;
    max-height: 300px;
}

@media (max-width: 768px) {
    .outcomes-container {
        grid-template-columns: 1fr;
    }

    .chart-sidebar {
        position: static;
    }
}
</style>

<div class="outcomes-container">
    <div class="main-content">
        <h1>Outcomes Analysis</h1>

        <nav>
            <a href="/">‚Üê Back to Dashboard</a>
        </nav>

        <div id="summary">
            <h2>Total Time Tracked: <strong>{{ total_time }}</strong></h2>
        </div>

        <div id="filters">
            <h3>Filter by Period</h3>
            <input type="hidden" id="period-outcomes" name="period" value="">
            <input type="hidden" id="from-outcomes" name="from" value="">
            <input type="hidden" id="to-outcomes" name="to" value="">
            <button hx-get="/api/outcomes"
                    hx-target="#outcomes-list"
                    hx-include="#period-outcomes, #from-outcomes, #to-outcomes, #limit-checkbox-outcomes"
                    hx-push-url="true"
                    hx-on::htmx:beforeRequest="setOutcomesPeriod('today'); syncOutcomesDateInputs()"
                    hx-on::htmx:afterRequest="outcomesFilterUpdated(event)">Today</button>
            <button hx-get="/api/outcomes"
                    hx-target="#outcomes-list"
                    hx-include="#period-outcomes, #from-outcomes, #to-outcomes, #limit-checkbox-outcomes"
                    hx-push-url="true"
                    hx-on::htmx:beforeRequest="setOutcomesPeriod('this-week'); syncOutcomesDateInputs()"
                    hx-on::htmx:afterRequest="outcomesFilterUpdated(event)">This Week</button>
            <button hx-get="/api/outcomes"
                    hx-target="#outcomes-list"
                    hx-include="#period-outcomes, #from-outcomes, #to-outcomes, #limit-checkbox-outcomes"
                    hx-push-url="true"
                    hx-on::htmx:beforeRequest="setOutcomesPeriod('this-month'); syncOutcomesDateInputs()"
                    hx-on::htmx:afterRequest="outcomesFilterUpdated(event)">This Month</button>
            <button hx-get="/api/outcomes"
                    hx-target="#outcomes-list"
                    hx-include="#period-outcomes, #from-outcomes, #to-outcomes, #limit-checkbox-outcomes"
                    hx-push-url="true"
                    hx-on::htmx:beforeRequest="setOutcomesPeriod(''); syncOutcomesDateInputs()"
                    hx-on::htmx:afterRequest="outcomesFilterUpdated(event)">All Time</button>

            <div style="margin-top: 1rem;">
                <h4>Custom Date Range</h4>
                <label>
                    From:
                    <input type="date" id="date-from-outcomes" hx-trigger="change" hx-get="/api/outcomes" hx-target="#outcomes-list" hx-include="#period-outcomes, #from-outcomes, #to-outcomes, #limit-checkbox-outcomes" hx-push-url="true" hx-on::htmx:beforeRequest="syncOutcomesDateInputs()" hx-on::htmx:afterRequest="outcomesFilterUpdated(event)">
                </label>
                <label style="margin-left: 1rem;">
                    To:
                    <input type="date" id="date-to-outcomes" hx-trigger="change" hx-get="/api/outcomes" hx-target="#outcomes-list" hx-include="#period-outcomes, #from-outcomes, #to-outcomes, #limit-checkbox-outcomes" hx-push-url="true" hx-on::htmx:beforeRequest="syncOutcomesDateInputs()" hx-on::htmx:afterRequest="outcomesFilterUpdated(event)">
                </label>
            </div>

            <div style="margin-top: 1rem;">
                <label>
                    <input type="checkbox" id="limit-checkbox-outcomes" name="limit" value="true" hx-trigger="change" hx-get="/api/outcomes" hx-target="#outcomes-list" hx-include="#period-outcomes, #from-outcomes, #to-outcomes, #limit-checkbox-outcomes" hx-push-url="true" hx-on::htmx:afterRequest="outcomesFilterUpdated(event)">
                    Limit to top 90%
                </label>
            </div>
        </div>

        <div id="outcomes-list">
            {% if outcomes.len() > 0 %}
            <h2>Outcomes</h2>
            <table>
                <thead>
                    <tr>
                        <th>Outcome</th>
                        <th>Duration</th>
                        <th>Percentage</th>
                    </tr>
                </thead>
                <tbody>
                    {% for outcome in outcomes %}
                    <tr>
                        <td>{{ outcome.description }}</td>
                        <td>{{ outcome.minutes }} min</td>
                        <td>{{ outcome.percentage }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p>No outcomes data available for this period.</p>
            {% endif %}
        </div>
    </div>

    <div class="chart-sidebar">
        <div id="chart-outcomes-pie" hx-get="/api/chart/outcomes-pie" hx-trigger="load" hx-swap="innerHTML" hx-include="#filters">
            <p>Loading chart...</p>
        </div>
    </div>
</div>

<script>
function setOutcomesPeriod(period) {
    const periodInput = document.getElementById('period-outcomes');
    periodInput.value = period;

    // Clear date range when switching periods
    document.getElementById('from-outcomes').value = '';
    document.getElementById('to-outcomes').value = '';
    document.getElementById('date-from-outcomes').value = '';
    document.getElementById('date-to-outcomes').value = '';
}

function syncOutcomesDateInputs() {
    // Sync visible date inputs to hidden ones for query string
    const dateFrom = document.getElementById('date-from-outcomes');
    const dateTo = document.getElementById('date-to-outcomes');
    const hiddenFrom = document.getElementById('from-outcomes');
    const hiddenTo = document.getElementById('to-outcomes');

    hiddenFrom.value = dateFrom.value;
    hiddenTo.value = dateTo.value;

    // Clear period when using date range
    if (dateFrom.value || dateTo.value) {
        document.getElementById('period-outcomes').value = '';
    }
}

function outcomesFilterUpdated(event) {
    const period = document.getElementById('period-outcomes').value;
    const from = document.getElementById('from-outcomes').value;
    const to = document.getElementById('to-outcomes').value;
    const limitCheckbox = document.getElementById('limit-checkbox-outcomes');
    const limit = limitCheckbox && limitCheckbox.checked ? 'true' : 'false';

    // Build query string with correct parameter names
    const params = new URLSearchParams();
    if (period) params.append('period', period);
    if (from) params.append('from', from);
    if (to) params.append('to', to);
    params.append('limit', limit);

    const queryString = params.toString();

    // Update summary
    htmx.ajax('GET', '/api/outcomes?' + queryString, {
        target: '#summary',
        swap: 'innerHTML'
    });

    // Update chart
    htmx.ajax('GET', '/api/chart/outcomes-pie?' + queryString, {
        target: '#chart-outcomes-pie',
        swap: 'innerHTML'
    });
}
</script>
{% endblock %}
