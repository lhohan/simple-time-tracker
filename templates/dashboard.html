{% extends "base.html" %}

{% block content %}
<style>
.dashboard-container {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 2rem;
    align-items: start;
}

.main-content {
    min-width: 0;
}

.chart-sidebar {
    position: sticky;
    top: 1rem;
}

.chart-sidebar canvas {
    max-width: 100%;
    max-height: 300px;
}

@media (max-width: 768px) {
    .dashboard-container {
        grid-template-columns: 1fr;
    }

    .chart-sidebar {
        position: static;
    }
}
</style>

<div class="dashboard-container">
    <div class="main-content">
        <h1>Time Tracker Dashboard</h1>

        <nav>
            <a href="/outcomes">View Outcomes â†’</a>
        </nav>

        <div id="summary">
            <h2>Total Time Tracked: <strong>{{ total_time }}</strong></h2>
        </div>

        <form id="filter-form">
            <div id="filters">
                <h3>Filter by Period</h3>
                <button type="button" hx-get="/api/dashboard" hx-vals='{"period":"today"}' hx-target="#projects" hx-include="#filter-form" hx-on::htmx:afterRequest="updateSummaryAndChart()">Today</button>
                <button type="button" hx-get="/api/dashboard" hx-vals='{"period":"this-week"}' hx-target="#projects" hx-include="#filter-form" hx-on::htmx:afterRequest="updateSummaryAndChart()">This Week</button>
                <button type="button" hx-get="/api/dashboard" hx-vals='{"period":"this-month"}' hx-target="#projects" hx-include="#filter-form" hx-on::htmx:afterRequest="updateSummaryAndChart()">This Month</button>
                <button type="button" hx-get="/api/dashboard" hx-target="#projects" hx-include="#filter-form" hx-on::htmx:afterRequest="updateSummaryAndChart()">All Time</button>

                <div style="margin-top: 1rem;">
                    <h4>Custom Date Range</h4>
                    <label>
                        From:
                        <input type="date" id="date-from" name="from" hx-trigger="change" hx-get="/api/dashboard" hx-target="#projects" hx-include="#filter-form" hx-on::htmx:afterRequest="updateSummaryAndChart()">
                    </label>
                    <label style="margin-left: 1rem;">
                        To:
                        <input type="date" id="date-to" name="to" hx-trigger="change" hx-get="/api/dashboard" hx-target="#projects" hx-include="#filter-form" hx-on::htmx:afterRequest="updateSummaryAndChart()">
                    </label>
                </div>

                <div style="margin-top: 1rem;">
                    <label>
                        <input type="checkbox" id="limit-checkbox" name="limit" value="true" hx-trigger="change" hx-get="/api/dashboard" hx-target="#projects" hx-include="#filter-form" hx-on::htmx:afterRequest="updateSummaryAndChart()">
                        Limit to top 90%
                    </label>
                </div>
            </div>
        </form>

        <div id="projects">
            {% if projects.len() > 0 %}
            <h2>Time by Project</h2>
            <table>
                <thead>
                    <tr>
                        <th>Project</th>
                        <th>Duration</th>
                        <th>Percentage</th>
                    </tr>
                </thead>
                <tbody>
                    {% for project in projects %}
                    <tr>
                        <td>
                            <a href="#" hx-get="/api/tag/{{ project.description }}" hx-target="#detail" hx-include="#filter-form">
                                {{ project.description }}
                            </a>
                        </td>
                        <td>{{ project.minutes }} min</td>
                        <td>{{ project.percentage }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p>No data for this period.</p>
            {% endif %}
        </div>

        <div id="detail"></div>
    </div>

    <div class="chart-sidebar">
        <div id="chart-pie" hx-get="/api/chart/projects-pie" hx-trigger="load" hx-swap="innerHTML" hx-include="#filter-form">
            <p>Loading chart...</p>
        </div>
    </div>
</div>

<script>
function updateSummaryAndChart() {
    const form = document.getElementById('filter-form');
    const formData = new FormData(form);
    const params = new URLSearchParams(formData);
    const queryString = params.toString() ? '?' + params.toString() : '';

    htmx.ajax('GET', '/api/dashboard/summary' + queryString, {
        target: '#summary',
        swap: 'innerHTML'
    });

    htmx.ajax('GET', '/api/chart/projects-pie' + queryString, {
        target: '#chart-pie',
        swap: 'innerHTML'
    });
}
</script>
{% endblock %}
