{% extends "base.html" %}

{% block content %}
<style>
.dashboard-container {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 2rem;
    align-items: start;
}

.main-content {
    min-width: 0;
}

.chart-sidebar {
    position: sticky;
    top: 1rem;
}

.chart-sidebar canvas {
    max-width: 100%;
    max-height: 300px;
}

@media (max-width: 768px) {
    .dashboard-container {
        grid-template-columns: 1fr;
    }

    .chart-sidebar {
        position: static;
    }
}
</style>

<div class="dashboard-container">
    <div class="main-content">
        <h1>Time Tracker Dashboard</h1>

        <nav>
            <a href="/outcomes">View Outcomes â†’</a>
        </nav>

        <div id="summary">
            <h2>Total Time Tracked: <strong>{{ total_time }}</strong></h2>
        </div>

        <div id="filters">
            <h3>Filter by Period</h3>
            <button hx-get="/api/dashboard?period=today" hx-target="#projects"
                    onclick="updateFilters('today')">Today</button>
            <button hx-get="/api/dashboard?period=this-week" hx-target="#projects"
                    onclick="updateFilters('this-week')">This Week</button>
            <button hx-get="/api/dashboard?period=this-month" hx-target="#projects"
                    onclick="updateFilters('this-month')">This Month</button>
            <button hx-get="/api/dashboard" hx-target="#projects"
                    onclick="updateFilters('')">All Time</button>

            <div style="margin-top: 1rem;">
                <h4>Custom Date Range</h4>
                <label>
                    From:
                    <input type="date" id="date-from" onchange="applyDateRange()">
                </label>
                <label style="margin-left: 1rem;">
                    To:
                    <input type="date" id="date-to" onchange="applyDateRange()">
                </label>
            </div>

            <div style="margin-top: 1rem;">
                <label>
                    <input type="checkbox" id="limit-checkbox" onchange="updateFilters()">
                    Limit to top 90%
                </label>
            </div>
        </div>

        <div id="projects">
            {% if projects.len() > 0 %}
            <h2>Time by Project</h2>
            <table>
                <thead>
                    <tr>
                        <th>Project</th>
                        <th>Duration</th>
                        <th>Percentage</th>
                    </tr>
                </thead>
                <tbody>
                    {% for project in projects %}
                    <tr>
                        <td>
                            <a href="#" hx-get="/api/tag/{{ project.description }}" hx-target="#detail">
                                {{ project.description }}
                            </a>
                        </td>
                        <td>{{ project.minutes }} min</td>
                        <td>{{ project.percentage }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p>No data for this period.</p>
            {% endif %}
        </div>

        <div id="detail"></div>
    </div>

    <div class="chart-sidebar">
        <div id="chart-pie" hx-get="/api/chart/projects-pie" hx-trigger="load" hx-swap="innerHTML">
            <p>Loading chart...</p>
        </div>
    </div>
</div>

<script>
let currentPeriod = '';
let currentDateFrom = '';
let currentDateTo = '';
let currentLimit = 'false';

function updateTagLinksWithFilters() {
    const tagLinks = document.querySelectorAll('a[hx-get*="/api/tag/"]');
    tagLinks.forEach(link => {
        const originalHref = link.getAttribute('hx-get');
        const tagName = originalHref.match(/\/api\/tag\/([^?]+)/)?.[1] || '';
        if (!tagName) return;

        const params = new URLSearchParams();
        if (currentPeriod) {
            params.append('period', currentPeriod);
        }
        if (currentDateFrom) {
            params.append('from', currentDateFrom);
        }
        if (currentDateTo) {
            params.append('to', currentDateTo);
        }
        params.append('limit', currentLimit);

        const queryString = params.toString();
        const newUrl = `/api/tag/${tagName}${queryString ? '?' + queryString : ''}`;
        link.setAttribute('hx-get', newUrl);
    });
}

function updateFilters(period) {
    if (period !== undefined) {
        currentPeriod = period;
        currentDateFrom = '';
        currentDateTo = '';
        // Reset checkbox and date inputs when period changes
        const limitCheckbox = document.getElementById('limit-checkbox');
        if (limitCheckbox) {
            limitCheckbox.checked = false;
        }
        // Clear date inputs when using period filters
        const dateFrom = document.getElementById('date-from');
        const dateTo = document.getElementById('date-to');
        if (dateFrom) dateFrom.value = '';
        if (dateTo) dateTo.value = '';
    }

    const limitCheckbox = document.getElementById('limit-checkbox');
    currentLimit = limitCheckbox && limitCheckbox.checked ? 'true' : 'false';

    // Build query string
    const params = new URLSearchParams();
    if (currentPeriod) {
        params.append('period', currentPeriod);
    }
    params.append('limit', currentLimit);

    const queryString = params.toString();

    // Update total time summary
    const summaryUrl = `/api/dashboard/summary?${queryString}`;
    htmx.ajax('GET', summaryUrl, {target:'#summary', swap:'innerHTML'});

    // Update projects table
    const projectsUrl = `/api/dashboard?${queryString}`;
    htmx.ajax('GET', projectsUrl, {target:'#projects', swap:'innerHTML'});

    // Update chart
    const pieUrl = `/api/chart/projects-pie?${queryString}`;
    htmx.ajax('GET', pieUrl, {target:'#chart-pie', swap:'innerHTML'});
}

function applyDateRange() {
    const dateFrom = document.getElementById('date-from');
    const dateTo = document.getElementById('date-to');

    // Only apply if both dates are filled
    if (!dateFrom.value || !dateTo.value) {
        return;
    }

    // Clear period when using date range
    currentPeriod = '';
    currentDateFrom = dateFrom.value;
    currentDateTo = dateTo.value;

    // Reset checkbox
    const limitCheckbox = document.getElementById('limit-checkbox');
    if (limitCheckbox) {
        limitCheckbox.checked = false;
    }

    currentLimit = 'false';

    // Build query string with date range
    const params = new URLSearchParams();
    params.append('from', currentDateFrom);
    params.append('to', currentDateTo);
    params.append('limit', currentLimit);

    const queryString = params.toString();

    // Update total time summary
    const summaryUrl = `/api/dashboard/summary?${queryString}`;
    htmx.ajax('GET', summaryUrl, {target:'#summary', swap:'innerHTML'});

    // Update projects table
    const projectsUrl = `/api/dashboard?${queryString}`;
    htmx.ajax('GET', projectsUrl, {target:'#projects', swap:'innerHTML'});

    // Update chart
    const pieUrl = `/api/chart/projects-pie?${queryString}`;
    htmx.ajax('GET', pieUrl, {target:'#chart-pie', swap:'innerHTML'});
}

document.addEventListener('htmx:afterSwap', updateTagLinksWithFilters);
</script>
{% endblock %}
