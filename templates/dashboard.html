{% extends "base.html" %}

{% block content %}
<style>
.dashboard-container {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 2rem;
    align-items: start;
}

.main-content {
    min-width: 0;
}

.chart-sidebar {
    position: sticky;
    top: 1rem;
}

.chart-sidebar canvas {
    max-width: 100%;
    max-height: 300px;
}

@media (max-width: 768px) {
    .dashboard-container {
        grid-template-columns: 1fr;
    }

    .chart-sidebar {
        position: static;
    }
}
</style>

<div class="dashboard-container">
    <div class="main-content">
        <h1>Time Tracker Dashboard</h1>

        <nav>
            <a href="/outcomes">View Outcomes →</a>
            <a href="/flag-statistics">View Flag Statistics →</a>
        </nav>

        <div id="summary">
            <h2>Total Time Tracked: <strong>{{ total_time }}</strong></h2>
        </div>

        <form id="filter-form">
            <input type="hidden" id="selected-period" name="period" value="">
            <div id="filters">
                <h3>Filter by Period</h3>
                <button type="button" hx-get="/api/dashboard" hx-target="#projects" hx-include="#filter-form" onclick="document.getElementById('selected-period').value = 'today'">Today</button>
                <button type="button" hx-get="/api/dashboard" hx-target="#projects" hx-include="#filter-form" onclick="document.getElementById('selected-period').value = 'this-week'">This Week</button>
                <button type="button" hx-get="/api/dashboard" hx-target="#projects" hx-include="#filter-form" onclick="document.getElementById('selected-period').value = 'this-month'">This Month</button>
                <button type="button" hx-get="/api/dashboard" hx-target="#projects" hx-include="#filter-form" onclick="document.getElementById('selected-period').value = ''">All Time</button>

                <div style="margin-top: 1rem;">
                    <h4>Custom Date Range</h4>
                    <label>
                        From:
                        <input type="date" id="date-from" name="from" hx-trigger="change" hx-get="/api/dashboard" hx-target="#projects" hx-include="#filter-form">
                    </label>
                    <label style="margin-left: 1rem;">
                        To:
                        <input type="date" id="date-to" name="to" hx-trigger="change" hx-get="/api/dashboard" hx-target="#projects" hx-include="#filter-form">
                    </label>
                </div>

                <div style="margin-top: 1rem;">
                    <label>
                        <input type="checkbox" id="limit-checkbox" name="limit" value="true" hx-trigger="change" hx-get="/api/dashboard" hx-target="#projects" hx-include="#filter-form">
                        Limit to top 90%
                    </label>
                </div>
            </div>
        </form>

        <div id="projects">
            {% if projects.len() > 0 %}
            <h2>Time by Project</h2>
            <table>
                <thead>
                    <tr>
                        <th>Project</th>
                        <th>Duration</th>
                        <th>Percentage</th>
                    </tr>
                </thead>
                <tbody>
                    {% for project in projects %}
                    <tr>
                        <td>
                            <a href="#" hx-get="/api/tag/{{ project.description }}" hx-target="#detail" hx-include="#filter-form">
                                {{ project.description }}
                            </a>
                        </td>
                        <td>{{ project.minutes }} min</td>
                        <td>{{ project.percentage }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p>No data for this period.</p>
            {% endif %}
        </div>

        <div id="detail"></div>
    </div>

    <div class="chart-sidebar">
        <div id="chart-pie">
            <canvas id="projects-pie-chart"></canvas>
        </div>
    </div>
</div>

<script>
(function() {
    const ctx = document.getElementById('projects-pie-chart');
    if (ctx && typeof Chart !== 'undefined') {
        if (window.projectsChart) {
            window.projectsChart.destroy();
        }

        const colors = [
            'rgba(255, 99, 132, 0.6)',
            'rgba(54, 162, 235, 0.6)',
            'rgba(255, 206, 86, 0.6)',
            'rgba(75, 192, 192, 0.6)',
            'rgba(153, 102, 255, 0.6)',
            'rgba(255, 159, 64, 0.6)',
            'rgba(199, 199, 199, 0.6)',
            'rgba(83, 102, 255, 0.6)',
            'rgba(255, 99, 255, 0.6)',
            'rgba(99, 255, 132, 0.6)'
        ];

        window.projectsChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: [{% for project in projects %}'{{ project.description }}'{% if !loop.last %}, {% endif %}{% endfor %}],
                datasets: [{
                    data: [{% for project in projects %}{{ project.percentage }}{% if !loop.last %}, {% endif %}{% endfor %}],
                    backgroundColor: colors.slice(0, {{ projects.len() }}),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            boxWidth: 12,
                            font: {
                                size: 11
                            }
                        }
                    },
                    title: {
                        display: true,
                        text: 'Project Distribution (%)',
                        font: {
                            size: 14
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.label + ': ' + context.parsed + '%';
                            }
                        }
                    }
                }
            }
        });
    }
})();
</script>
{% endblock %}
